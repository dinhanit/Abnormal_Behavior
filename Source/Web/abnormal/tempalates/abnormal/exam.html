{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Exam Online</title>
</head>
<body>
    <h1 class="exam-title">EXAM ONLINE</h1>
    <div class="container">
        <div class="webcam">
            <h2 class="camera-name">Student Webcam</h2>
            <video id="webcam-stream" autoplay></video>
        </div>
        <div class="exam">
            <label for="gender">Gender:</label><br>
            <input type="radio" id="male" name="gender" value="male">
            <label for="male">Male</label><br>
            <input type="radio" id="female" name="gender" value="female">
            <label for="female">Female</label><br>

            <label for="campus">Campus:</label><br>
            <input type="radio" id="HCM" name="campus" value="HCM">
            <label for="HCM">Ho Chi Minh</label><br>
            <input type="radio" id="QN" name="campus" value="QN">
            <label for="QN">Quy Nhon</label><br>

            <label for="accommodation">Accommodation:</label><br>
            <input type="radio" id="dormitory" name="accommodation" value="dormitory">
            <label for="dormitory">Dormitory</label><br>
            <input type="radio" id="other" name="accommodation" value="other">
            <label for="other">Other</label><br>
        </div>
    </div>
    <div id="code-form-container" style="display: none;">
        <form id="code-form">
            <h3 style="color: red;">Abnormal behavior detected. Interaction disabled.</h3>
            <label for="code">Enter Code:</label>
            <input type="text" id="code" name="code" required>
            <button type="submit">Submit</button>
        </form>
    </div>
    <div class="wrapper">
        <div class="galaxy">
            <div class="sun"></div>
            <div class="orbit earth">
                <div class="globe earth">
                    <div class="orbit moon">
                        <div class="globe moon"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="clock">
            <p class="date">2023-11-13 MON</p>
            <p class="time">14:15:00</p>
            <p class="text">Good Luck!</p>
        </div>
    </div>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-image: url("{% static 'img/breadcrumb-bg.jpg' %}");
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: white;
        }
        .exam-title {
            text-align: center;
        }
        .camera-name{
            text-align: center;
        }
        .container {
            display: flex;
            justify-content: space-between;
            margin-top: 50px;
        }
        
        .webcam,
        .exam {
            flex: 1;
            border: 2px solid #ffffff;
            padding: 0;
        }
        
        #code-form-container {
            text-align: center;
        }
        
        .wrapper {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .galaxy {
            height: 400px;
            width: 400px;
            position: relative;
        }
        
        .sun {
            height: 100px;
            width: 100px;
            background-color: yellow;
            border-radius: 50%;
            box-shadow: 0 0 30px white;
            position: absolute;
            top: 150px;
            left: 150px;
        }
        
        .globe.earth {
            background: aqua;
            height: 30px;
            right: 28px;
            top: 28px;
            width: 30px;
        }
        
        .globe.moon {
            width: 12px;
            height: 12px;
            background: #d6d6d6;
            right: 2px;
            top: 8px;
        }
        
        .globe {
            border-radius: 50%;
            position: absolute;
        }
        
        .orbit.earth {
            position: relative;
            animation: orbit 60s linear infinite;
            height: 300px;
            left: 50px;
            top: 50px;
            width: 300px;
        }
        
        .orbit.moon {
            animation: orbit 1s linear infinite;
            height: 80px;
            left: -25px;
            top: -25px;
            width: 80px;
        }
        
        .orbit {
            position: relative;
            border: solid;
            border-color: white transparent transparent transparent;
            border-radius: 50%;
            border-width: 1px 1px 0 0;
            box-sizing: border-box;
            transform: rotate(0deg);
            transform-origin: center;
        }
        
        .clock {
            font-family: 'Share Tech Mono', monospace;
            text-align: right;
            color: #d6f6ff;
            text-shadow: 0 0 20px rgba(10, 175, 230, 1), 0 0 20px rgba(10, 175, 203, 0);
            margin-top: 40px;
            margin-right: 20px;
        }
        
        .date {
            letter-spacing: 0.1em;
            font-size: 10px;
        }
        
        .time {
            letter-spacing: 0.05em;
            font-size: 15px;
        }
        
        .text {
            letter-spacing: 0.1em;
            font-size: 10px;
        }
        
        @keyframes orbit {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const videoElement = document.getElementById('webcam-stream');
        const csrfToken = '{{ csrf_token }}';
        const abnormalUrl = "{{ abnormal_url }}";  // Use the URL from the context
        let frameCount = 0;
        let captureFrames = true;  // Flag to control whether frames should be captured
        
        // Function to capture and send frames to Django server
        const captureAndSendFrame = () => {
            if (!captureFrames) {
                return;  // Skip capturing frames if the flag is false
            }
            const canvasElement = document.createElement('canvas');
            const context = canvasElement.getContext('2d');
            
            // Capture a frame from the webcam
            context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
            
            // Convert the captured frame to a binary blob (image/jpeg)
            canvasElement.toBlob(function(blob) {
                // Create a FormData object to send the binary blob
                const formData = new FormData();
                formData.append('frame_data', blob, 'frame.jpg');
                
                // Increment frame count
                frameCount++;
        
                if (frameCount >= 1) {
                    // Send the captured frames as a binary file
                    fetch(abnormalUrl, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': csrfToken
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data.message);
                    })
                    .catch(error => {
                        console.error('Error sending frames:', error);
                    });
        
                    // Reset frame count
                    frameCount = 0;
                }
            }, 'image/jpeg');
            
            // Repeat the process to capture and send frames
            requestAnimationFrame(captureAndSendFrame);
        };
        
        
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(function (stream) {
                videoElement.srcObject = stream;
                captureAndSendFrame(); // Start capturing and sending framesa
            })
            .catch(function (error) {
                console.error('Error accessing camera:', error);
            });
            var abnormalCount = 0;
            var webcamStream = null;
        
            // Function to periodically update the abnormal count
            function updateAbnormalCount() {
                $.ajax({
                    url: '{% url "abnormal" %}',  // Use the URL pattern name for the "abnormal" view
                    type: 'GET',
                    dataType: 'json',
                    success: function (data) {
                        if (data.abnormal_count !== undefined) {
                            abnormalCount = data.abnormal_count;
        
                            // Check and take action based on abnormalCount
                            if (abnormalCount >= 800) {
                                captureFrames = false;
                                disableInteraction();
                                checkexamcode()
                            }
                        }
                    },
                    error: function () {
                        // Handle any errors if the AJAX request fails
                    }
                });
            }
        
            // Function to disable user interaction and stop webcam stream
            function disableInteraction() {
                var radioButtons = document.querySelectorAll('input[type="radio"]');
                for (var i = 0; i < radioButtons.length; i++) {
                    radioButtons[i].disabled = true;
                }
        
                // Stop the webcam stream (assuming the webcamStream is correctly defined elsewhere)
                if (webcamStream) {
                    var videoElement = document.getElementById('webcam-stream');
                    var tracks = videoElement.srcObject.getTracks();
                    
                    tracks.forEach(function (track) {
                        track.stop();
                    });
            
                    videoElement.srcObject = null;
                    webcamStream = null;
                }
                // Update the flag to stop capturing frames
                captureFrames = false;
                // Show the code form container
                document.getElementById('code-form-container').style.display = 'block';
        
                // Prevent the form from submitting
                return false;
            }
        
            // Periodically update the abnormalCount
            setInterval(updateAbnormalCount, 1000);  // Adjust the interval as needed
            
        
            //Function to creat random exam code
            function checkexamcode() {
                document.getElementById('code-form').addEventListener('submit', function (event) {
                    event.preventDefault();
            
                    const enteredCode = document.getElementById('code').value;
            
                    // Send the entered code to the server for verification
                    const formData = new FormData();
                    formData.append('entered_code', enteredCode);
                    formData.append('csrfmiddlewaretoken', csrfToken);
            
                    fetch('{% url "verify_code" %}', {
                        method: 'POST',
                        body: formData,
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.code_verified) {
                            // Re-enable the camera and exam
                            enableInteraction();
                        } else {
                            alert('Incorrect code. Please try again.');
                        }
                    })
                    .catch(error => {
                        console.error('Error verifying code:', error);
                    });
                });
            }
            
            // Function to re-enable user interaction and start webcam stream
            function enableInteraction() {
                var radioButtons = document.querySelectorAll('input[type="radio"]');
                for (var i = 0; i < radioButtons.length; i++) {
                    radioButtons[i].disabled = false;
                }
            
                // Restart the webcam stream (assuming the webcamStream is correctly defined elsewhere)
                if (webcamStream) {
                    var videoElement = document.getElementById('webcam-stream');
                    navigator.mediaDevices.getUserMedia({ video: true })
                        .then(function (stream) {
                            videoElement.srcObject = stream;
                            captureAndSendFrame(); // Start capturing and sending frames
                        })
                        .catch(function (error) {
                            console.error('Error accessing camera:', error);
                        });
                }
                captureFrames = true
                document.getElementById('code-form-container').style.display = 'none';
                captureAndSendFrame();
            }
        const dayOfWeek = [
        "SUN", "MON", "TUE",
        "WED", "THU", "FRI", "SAT"
        ];
        const $time = document.querySelector(".time");
        const $date = document.querySelector(".date");
        
        function padStart(value, length) {
            return String(value).padStart(length, "0");
        }
        
        function update() {
            const now = new Date();
            const [
                hours, minutes, seconds,
                year, month, date, day,
            ] = [
                now.getHours(), now.getMinutes(), now.getSeconds(),
                now.getFullYear(), now.getMonth(), now.getDate(), now.getDay(),
            ];
        
            $time.innerText = `${padStart(hours, 2)}:${padStart(minutes, 2)}:${padStart(seconds, 2)}`;
            $date.innerText = `${padStart(year, 4)}-${padStart(month + 1, 2)}-${padStart(date, 2)} ${dayOfWeek[day]}`;
        }
        
        update();
        setInterval(update, 1000);
    </script>
</body>
</html>
